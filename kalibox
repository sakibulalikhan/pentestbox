#!/bin/bash

#LICENSE: https://github.com/sakibulalikhan/pentestbox/blob/main/LICENSE

echo -e " ▄▄▄   ▄ ▄▄▄▄▄▄ ▄▄▄     ▄▄▄ ▄▄▄▄▄▄▄ ▄▄▄▄▄▄▄ ▄▄   ▄▄  "
echo -e "█   █ █ █      █   █   █   █  ▄    █       █  █▄█  █ "
echo -e "█   █▄█ █  ▄   █   █   █   █ █▄█   █   ▄   █       █ "
echo -e "█      ▄█ █▄█  █   █   █   █       █  █ █  █       █ "
echo -e "█     █▄█      █   █▄▄▄█   █  ▄   ██  █▄█  ██     █  "
echo -e "█    ▄  █  ▄   █       █   █ █▄█   █       █   ▄   █ "
echo -e "█▄▄▄█ █▄█▄█ █▄▄█▄▄▄▄▄▄▄█▄▄▄█▄▄▄▄▄▄▄█▄▄▄▄▄▄▄█▄▄█ █▄▄█ "
echo -e "+---------------------------------------------------+"
echo -e "|            Author : @sakibulalikhan               |"
echo -e "+---------------------------------------------------+\n"

command_exists() {
    command -v "$1" >/dev/null 2>&1
}

container_exists() {
    local container_name="$1"
    docker inspect -f '{{.State.Running}}' "$container_name" 2>/dev/null
}

if ! command_exists "distrobox"; then
    echo "distrobox command not found. Installing..."
    wget -qO- https://raw.githubusercontent.com/89luca89/distrobox/main/install | sudo sh
fi

if [ "$#" -eq 0 ] || [ "$1" == "start" ]; then
    echo "Starting services..."
    sudo systemctl start docker
    sudo chmod 666 /var/run/docker.sock
    if ! container_exists "kalibox"; then
        echo "Error response from daemon: No such container: kalibox"
        echo "Cannot find container kalibox"
        read -p "Create it now, out of image kalilinux/kali-rolling? [Y/n]: " create_container
        if [ "$create_container" == "Y" ] || [ "$create_container" == "y" ]; then
            distrobox create -n kalibox -i kalilinux/kali-rolling
        else
            echo "Ok. For creating it, run this command:"
            echo "  distrobox create -n <name-of-container> -i <image>"
        fi
    fi
    distrobox enter kalibox
elif [ "$1" == "stop" ]; then
    echo "Stopping services..."
    distrobox stop kalibox
elif [ "$1" == "remove" ]; then
    echo "Removing container kalibox..."
    if container_exists "kalibox"; then
        distrobox rm kalibox
    else
        echo "Container kalibox does not exist."
    fi
elif [ "$1" == "help" ]; then
    echo "Usage: ./kalibox [start|stop|remove|help]"
    echo "  ./kalibox start  : Start the kalibox services"
    echo "  ./kalibox stop   : Stop the kalibox services"
    echo "  ./kalibox remove : Remove the kalibox container"
    echo "  ./kalibox help   : Show the help message kalibox"
else
    echo "Invalid command. Use './kalibox help' for usage information."
fi
